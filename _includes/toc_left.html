<aside class="toc-left" aria-label="On this page">
  <div class="toc-left-title">
    On this page
    <span class="toc-left-actions">
      <button type="button" id="toc-collapse-all" title="Collapse all" aria-label="Collapse all">–</button>
      <button type="button" id="toc-expand-all" title="Expand all" aria-label="Expand all">+</button>
    </span>
  </div>
  <nav class="toc-left-nav" role="navigation" aria-label="Table of contents">
    <ul id="toc-left-list" class="toc-left-list"></ul>
  </nav>
</aside>

<style>
.toc-left {
  position: sticky;
  top: 80px;
  align-self: start;
  width: 260px;
  max-height: calc(100vh - 100px);
  overflow: auto;
  border-right: 1px solid var(--border-color);
  padding-right: 16px;
  padding-left: 8px;
  box-sizing: border-box;
  font-size: 0.9rem;
}
.toc-left-title {
  font-weight: 600;
  font-size: 0.82rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--secondary-text-color, #9b9b9b);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 8px;
}
.toc-left-actions {
  display: inline-flex;
}
.toc-left-actions button {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--secondary-text-color);
  border-radius: 10px;
  width: 24px;
  height: 24px;
  font-size: 12px;
  line-height: 1;
  cursor: pointer;
  margin-left: 6px;
}
.toc-left-nav ul { list-style: none; margin: 0; padding: 0; }
.toc-left-nav li { margin: 0; padding: 2px 0; }
.toc-left-nav a {
  color: var(--secondary-text-color, #9b9b9b);
  text-decoration: none;
  display: block;
  border-left: 2px solid transparent;
  padding-left: 6px;
  line-height: 1.4;
  font-size: 0.86rem;
  word-break: break-word;
  transition: color 0.15s ease, border-color 0.15s ease;
}
.toc-left-nav a:hover { color: var(--text-color, #e1e1e1); }
.toc-left-nav a.active { color: var(--text-color, #e1e1e1); border-left-color: var(--text-color, #e1e1e1); }
.toc-left-nav ul ul a { padding-left: 16px; font-size: 0.8rem; }
.toc-left-nav ul ul ul a { padding-left: 28px; font-size: 0.76rem; opacity: 0.95; }

/* Collapsible controls */
.toc-toggle {
  display: inline-block;
  margin-right: 4px;
  color: var(--secondary-text-color);
  cursor: pointer;
  user-select: none;
}
.has-children > .toc-row { display: flex; align-items: center; }
.has-children.collapsed > ul { display: none; }
.toc-toggle::before { content: '▾'; display: inline-block; transition: transform 0.15s ease; }
.has-children.collapsed > .toc-row .toc-toggle::before { transform: rotate(-90deg); }

@media (max-width: 1100px) {
  .toc-left {
    position: static;
    width: 100%;
    max-height: none;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 6px;
    background: var(--surface-elevated-color);
  }
  .toc-left-nav {
    max-height: 40vh;
    overflow: auto;
    padding-right: 6px;
  }
  .toc-left-title {
    margin-bottom: 10px;
  }
}

.toc-left::-webkit-scrollbar { width: 3px; }
.toc-left::-webkit-scrollbar-track { background: var(--surface-elevated-color); border-radius: 3px; }
.toc-left::-webkit-scrollbar-thumb { background: var(--secondary-text-color, #9b9b9b); border-radius: 3px; }
.toc-left:hover::-webkit-scrollbar-thumb { background: var(--text-color, #e1e1e1); }
</style>

<script>
(function() {
  // Build a fresh, deterministic TOC on the left
  function buildTOC() {
    const content = document.querySelector('article .post-content, .post .post-content, .post-content');
    const list = document.getElementById('toc-left-list');
    if (!content || !list) return;

    // Collect headings and sort by visual position
    let hs = Array.from(content.querySelectorAll('h2, h3, h4'));
    if (!hs.length) return;
    hs = hs
      .filter(h => h.offsetParent !== null)
      .map(h => ({ el: h, top: h.getBoundingClientRect().top + window.scrollY }))
      .sort((a, b) => a.top - b.top)
      .map(x => x.el);

    // Unique, Unicode-safe slugs
    const slugCounts = new Map();
    function slugify(text) {
      const base = (text || '')
        .trim().toLowerCase()
        .replace(/[^\p{L}\p{N}\s-]/gu, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
      const count = (slugCounts.get(base) || 0) + 1;
      slugCounts.set(base, count);
      return count > 1 ? `${base}-${count}` : base;
    }

    hs.forEach(h => { if (!h.id) h.id = slugify(h.textContent || h.innerText || 'section'); });

    // Build nested structure
    const root = document.createElement('ul');
    const stack = [{ level: 2, ul: root }];
    const cur = () => stack[stack.length - 1];

    hs.forEach(h => {
      const lvl = Math.min(4, Math.max(2, parseInt(h.tagName.substring(1), 10) || 2));
      while (cur().level < lvl) {
        const parentLi = cur().ul.lastElementChild || cur().ul.appendChild(document.createElement('li'));
        const newUl = document.createElement('ul');
        parentLi.appendChild(newUl);
        stack.push({ level: cur().level + 1, ul: newUl });
      }
      while (cur().level > lvl && stack.length > 1) {
        stack.pop();
      }
      const li = document.createElement('li');
      const row = document.createElement('div');
      row.className = 'toc-row';
      const a = document.createElement('a');
      a.href = `#${h.id}`;
      a.textContent = (h.textContent || '').trim();
      a.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById(h.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setActive(h.id, true);
        // Ensure ancestors are expanded when jumping
        expandAncestors(a);
      });
      row.appendChild(a);
      li.appendChild(row);
      cur().ul.appendChild(li);
    });

    list.innerHTML = '';
    list.appendChild(root);

    // Collapsible: add toggles for items that have children
    function setupCollapsers() {
      list.querySelectorAll('li').forEach(li => {
        const childUl = li.querySelector(':scope > ul');
        const row = li.querySelector(':scope > .toc-row');
        if (childUl && row) {
          li.classList.add('has-children');
          const toggle = document.createElement('span');
          toggle.className = 'toc-toggle';
          toggle.title = 'Collapse/expand';
          toggle.addEventListener('click', () => {
            li.classList.toggle('collapsed');
          });
          row.insertBefore(toggle, row.firstChild);
        }
      });
    }

    function expandAncestors(anchorEl) {
      let node = anchorEl.closest('li');
      while (node) {
        node.classList.remove('collapsed');
        node = node.parentElement?.closest('li') || null;
      }
    }

    // Highlight active heading
    function setActive(id, expand = false) {
      list.querySelectorAll('a').forEach(a => {
        const isActive = a.getAttribute('href') === `#${id}`;
        a.classList.toggle('active', isActive);
        if (isActive && expand) expandAncestors(a);
      });
    }

    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        let topMost = null;
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          if (!topMost || entry.boundingClientRect.top < topMost.boundingClientRect.top) {
            topMost = entry;
          }
        });
        if (topMost?.target?.id) setActive(topMost.target.id, true);
      }, { root: null, rootMargin: '-25% 0px -65% 0px', threshold: [0] });
      hs.forEach(h => io.observe(h));
    }

    // Initial state
    setupCollapsers();
    setActive(hs[0].id, true);
    // Collapse all by default? Keep expanded; user can collapse.

    // Wire global collapse/expand
    const btnCollapseAll = document.getElementById('toc-collapse-all');
    const btnExpandAll = document.getElementById('toc-expand-all');
    btnCollapseAll?.addEventListener('click', () => {
      list.querySelectorAll('.has-children').forEach(li => li.classList.add('collapsed'));
    });
    btnExpandAll?.addEventListener('click', () => {
      list.querySelectorAll('.has-children').forEach(li => li.classList.remove('collapsed'));
    });
  }

  function initTOC() {
    buildTOC();
    // Recompute after full load to catch layout shifts
    window.addEventListener('load', () => setTimeout(buildTOC, 50));
  }

  document.addEventListener('DOMContentLoaded', initTOC);
})();
</script>
