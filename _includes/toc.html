<!-- Floating Table of Contents (rebuilt) -->
<nav id="toc-container" class="toc-container" aria-label="On this page">
  <div class="toc-header">On this page</div>
  <div id="toc-nav" class="toc-nav" role="navigation" aria-label="Table of contents"></div>
  <button id="toc-minimize" class="toc-minimize" aria-label="Minimize TOC" title="Minimize">â€“</button>
  <button id="toc-maximize" class="toc-maximize" aria-label="Expand TOC" title="Expand">+</button>
</nav>

<style>
.toc-container {
  position: fixed;
  right: 30px;
  top: 100px;
  bottom: 50px;
  width: 240px;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 100;
  font-family: 'Inconsolata', monospace;
  font-size: 12px;
  line-height: 1.45;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  border-left: 1px solid var(--border, rgba(255,255,255,0.08));
  padding-left: 10px;
}

.toc-container.visible { opacity: 1; pointer-events: auto; }
.toc-container.minimized { opacity: 0.2; }
.toc-container.minimized:hover { opacity: 1; }

.toc-header {
  color: var(--secondary-text-color, #9b9b9b);
  font-weight: 700;
  margin-bottom: 6px;
}

.toc-nav ul { list-style: none; margin: 0; padding: 0; }
.toc-nav li { margin: 0; padding: 2px 0; }
.toc-nav a {
  color: var(--secondary-text-color, #9b9b9b);
  text-decoration: none;
  display: block;
  border-left: 2px solid transparent;
  padding-left: 6px;
  transition: color 0.15s ease, border-color 0.15s ease;
}
.toc-nav a:hover { color: var(--text-color, #e1e1e1); }
.toc-nav a.active { color: var(--text-color, #e1e1e1); border-left-color: var(--text-color, #e1e1e1); }

/* Nested indentation */
.toc-nav ul ul a { padding-left: 16px; font-size: 11px; }
.toc-nav ul ul ul a { padding-left: 28px; font-size: 10px; opacity: 0.9; }

/* Controls */
.toc-minimize, .toc-maximize {
  position: absolute;
  right: 8px;
  background: none;
  border: 1px solid var(--border, rgba(255,255,255,0.15));
  border-radius: 12px;
  width: 24px; height: 24px;
  color: var(--secondary-text-color);
  cursor: pointer;
}
.toc-minimize { top: 8px; }
.toc-maximize { top: 8px; display: none; }
.toc-container.minimized .toc-minimize { display: none; }
.toc-container.minimized .toc-maximize { display: inline-block; }

/* Hide on smaller screens */
@media (max-width: 1200px) { .toc-container { display: none; } }

/* Scrollbar */
.toc-container::-webkit-scrollbar { width: 3px; }
.toc-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
.toc-container::-webkit-scrollbar-thumb { background: var(--secondary-text-color, #9b9b9b); border-radius: 3px; }
.toc-container:hover::-webkit-scrollbar-thumb { background: var(--text-color, #e1e1e1); }
</style>

<script>
(function() {
  // Prevent browser from restoring mid-article scroll on navigation
  if ('scrollRestoration' in history) {
    try { history.scrollRestoration = 'manual'; } catch (e) {}
  }

  function buildTOC() {
    const articleContent = document.querySelector('article .post-content, .post .post-content, .post-content');
    const tocContainer = document.getElementById('toc-container');
    const tocNav = document.getElementById('toc-nav');
    if (!articleContent || !tocContainer || !tocNav) return false;

    // If arriving without a hash, force page to top to ensure TOC starts at the beginning
    if (!location.hash) {
      window.scrollTo(0, 0);
    }

    // Collect headings (ignore H1), then sort by vertical position
    let headings = Array.from(articleContent.querySelectorAll('h2, h3, h4'));
    if (!headings.length) { tocContainer.classList.remove('visible'); return false; }
    headings = headings
      .filter(h => h.offsetParent !== null) // visible
      .sort((a, b) => a.offsetTop - b.offsetTop);

    // Slugify with Unicode support and unique suffixes
    const slugCounts = new Map();
    function slugify(text) {
      const base = (text || '')
        .trim()
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s-]/gu, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
      const count = (slugCounts.get(base) || 0) + 1;
      slugCounts.set(base, count);
      return count > 1 ? `${base}-${count}` : base;
    }

    // Ensure IDs
    headings.forEach(h => { if (!h.id) h.id = slugify(h.textContent || h.innerText || 'section'); });

    // Build nested structure H2 > H3 > H4 deterministically using level transitions
    const rootUl = document.createElement('ul');
    const stack = [{ level: 2, ul: rootUl }];
    function current() { return stack[stack.length - 1]; }

    headings.forEach(h => {
      const level = Math.min(4, Math.max(2, parseInt(h.tagName.substring(1), 10) || 2));

      // Ascend to the correct level
      while (current().level < level) {
        const parentLi = current().ul.lastElementChild || current().ul.appendChild(document.createElement('li'));
        const newUl = document.createElement('ul');
        parentLi.appendChild(newUl);
        stack.push({ level: current().level + 1, ul: newUl });
      }
      // Descend if needed
      while (current().level > level && stack.length > 1) {
        stack.pop();
      }

      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${h.id}`;
      a.textContent = (h.textContent || '').trim();
      a.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById(h.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setActive(h.id);
      });
      li.appendChild(a);
      current().ul.appendChild(li);
    });

    tocNav.innerHTML = '';
    tocNav.appendChild(rootUl);
    tocContainer.classList.add('visible');

    // Active section highlighting
    function setActive(id) {
      const links = tocNav.querySelectorAll('a');
      links.forEach(link => link.classList.toggle('active', link.getAttribute('href') === `#${id}`));
    }

    if ('IntersectionObserver' in window) {
      // Delay observer setup slightly to let initial scroll position settle
      setTimeout(() => {
        const observer = new IntersectionObserver((entries) => {
          let topMost = null;
          entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            if (!topMost || entry.boundingClientRect.top < topMost.boundingClientRect.top) {
              topMost = entry;
            }
          });
          if (topMost?.target?.id) setActive(topMost.target.id);
        }, { root: null, rootMargin: '-20% 0px -75% 0px', threshold: [0] });
        headings.forEach(h => observer.observe(h));
      }, 250);
    }

    // Initial state + UX niceties
    tocContainer.scrollTop = 0;
    window.addEventListener('load', () => setTimeout(() => { tocContainer.scrollTop = 0; }, 50));
    setActive(headings[0].id);
    setTimeout(() => tocContainer.classList.add('minimized'), 2500);

    // Minimize/expand controls
    const btnMin = document.getElementById('toc-minimize');
    const btnMax = document.getElementById('toc-maximize');
    btnMin?.addEventListener('click', () => tocContainer.classList.add('minimized'));
    btnMax?.addEventListener('click', () => tocContainer.classList.remove('minimized'));

    return true;
  }

  function init() {
    const isPostPage = !!document.querySelector('article.post .post-content, article .post-content, .post .post-content');
    if (!isPostPage) return;
    // Build once on DOM ready and again on window load to get correct offsets after images/layout
    buildTOC();
    window.addEventListener('load', () => setTimeout(buildTOC, 50));
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
