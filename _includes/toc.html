<!-- Floating Table of Contents -->
<div id="toc-container" class="toc-container">
    <div class="toc-header">
        <span>Contents</span>
        <button class="toc-toggle" onclick="toggleTOC()">−</button>
    </div>
    <nav id="toc-nav" class="toc-nav">
        <!-- TOC will be populated by JavaScript -->
    </nav>
</div>

<style>
.toc-container {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 250px;
    max-height: 70vh;
    background: var(--background-color, #000);
    border: 1px solid var(--secondary-text-color, #9b9b9b);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 100;
    transition: all 0.3s ease;
}

.toc-container.collapsed {
    width: auto;
}

.toc-container.collapsed .toc-nav {
    display: none;
}

.toc-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--secondary-text-color, #9b9b9b);
    font-weight: 600;
    font-size: 0.9em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
}

.toc-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    color: var(--text-color, #e1e1e1);
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toc-nav {
    max-height: calc(70vh - 50px);
    overflow-y: auto;
    padding: 8px 0;
}

.toc-nav ul {
    list-style: none;
    margin: 0;
    padding: 0;
}

.toc-nav li {
    margin: 0;
    padding: 0;
}

.toc-nav a {
    display: block;
    padding: 6px 16px;
    color: var(--text-color, #e1e1e1);
    text-decoration: none;
    font-size: 0.85em;
    transition: all 0.2s ease;
    border-left: 2px solid transparent;
}

.toc-nav a:hover {
    background: rgba(255,255,255,0.05);
    border-left-color: var(--inline-code-color, #e06c75);
}

.toc-nav a.active {
    background: rgba(255,255,255,0.08);
    border-left-color: var(--inline-code-color, #e06c75);
    font-weight: 600;
}

/* Indentation for nested headings */
.toc-nav .toc-h2 {
    padding-left: 24px;
}

.toc-nav .toc-h3 {
    padding-left: 40px;
}

.toc-nav .toc-h4 {
    padding-left: 56px;
}

/* Hide on mobile */
@media (max-width: 1200px) {
    .toc-container {
        display: none;
    }
}

/* Scrollbar styling */
.toc-nav::-webkit-scrollbar {
    width: 4px;
}

.toc-nav::-webkit-scrollbar-track {
    background: transparent;
}

.toc-nav::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 2px;
}

.toc-nav::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.3);
}
</style>

<script>
// Generate Table of Contents
function generateTOC() {
    const tocNav = document.getElementById('toc-nav');
    let headings = document.querySelectorAll('.post-content h2, .post-content h3, .post-content h4');
    
    console.log('Found ' + headings.length + ' headings for TOC');
    
    if (headings.length === 0) {
        // Try without .post-content in case the class is different
        headings = document.querySelectorAll('article h2, article h3, article h4');
        console.log('Found ' + headings.length + ' headings in article');
        if (headings.length === 0) return;
    }
    
    const tocList = document.createElement('ul');
    
    headings.forEach((heading, index) => {
        // Create unique ID if heading doesn't have one
        if (!heading.id) {
            heading.id = 'heading-' + index;
        }
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        a.className = 'toc-' + heading.tagName.toLowerCase();
        
        // Smooth scroll on click
        a.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.getElementById(heading.id);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Update active state
                updateActiveSection(heading.id);
            }
        });
        
        li.appendChild(a);
        tocList.appendChild(li);
    });
    
    tocNav.appendChild(tocList);
}

// Update active section based on scroll
function updateActiveSection(activeId) {
    const links = document.querySelectorAll('.toc-nav a');
    links.forEach(link => {
        if (link.getAttribute('href') === '#' + activeId) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}

// Track scroll to highlight current section
function trackScroll() {
    // For expandable posts on home page
    const expandedPost = document.querySelector('.post-content.expanded');
    let headings;
    
    if (expandedPost) {
        headings = expandedPost.querySelectorAll('h2, h3, h4');
    } else {
        // For traditional post pages
        headings = document.querySelectorAll('.post-content h2, .post-content h3, .post-content h4');
        if (headings.length === 0) {
            headings = document.querySelectorAll('article h2, article h3, article h4');
        }
    }
    
    if (!headings || headings.length === 0) return;
    
    const scrollPosition = window.scrollY + 100;
    
    let currentSection = null;
    
    headings.forEach(heading => {
        const rect = heading.getBoundingClientRect();
        const absoluteTop = rect.top + window.scrollY;
        
        if (absoluteTop <= scrollPosition) {
            currentSection = heading.id;
        }
    });
    
    if (currentSection) {
        updateActiveSection(currentSection);
    }
}

// Toggle TOC visibility
function toggleTOC() {
    const container = document.getElementById('toc-container');
    const toggle = document.querySelector('.toc-toggle');
    
    container.classList.toggle('collapsed');
    toggle.textContent = container.classList.contains('collapsed') ? '+' : '−';
    
    // Save state to localStorage
    localStorage.setItem('toc-collapsed', container.classList.contains('collapsed'));
}

// Make TOC draggable
function makeDraggable() {
    const container = document.getElementById('toc-container');
    const header = container.querySelector('.toc-header');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        if (e.target.classList.contains('toc-toggle')) return;
        
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === header || header.contains(e.target)) {
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            xOffset = currentX;
            yOffset = currentY;

            container.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
    }

    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }
}

// Generate TOC for expanded post
function generateTOCForPost(postContent) {
    const tocNav = document.getElementById('toc-nav');
    if (!tocNav) return;
    
    // Clear existing TOC
    tocNav.innerHTML = '';
    
    // Find headings in the expanded post
    const headings = postContent.querySelectorAll('h2, h3, h4');
    console.log('Generating TOC for expanded post with ' + headings.length + ' headings');
    
    if (headings.length === 0) {
        document.getElementById('toc-container').style.display = 'none';
        return;
    }
    
    document.getElementById('toc-container').style.display = 'block';
    
    const tocList = document.createElement('ul');
    
    headings.forEach((heading, index) => {
        // Create unique ID if heading doesn't have one
        if (!heading.id) {
            heading.id = 'heading-' + Date.now() + '-' + index;
        }
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        a.className = 'toc-' + heading.tagName.toLowerCase();
        
        // Smooth scroll on click
        a.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.getElementById(heading.id);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                updateActiveSection(heading.id);
            }
        });
        
        li.appendChild(a);
        tocList.appendChild(li);
    });
    
    tocNav.appendChild(tocList);
    
    // Start tracking scroll for this post
    trackScroll();
}

// Watch for post expansion
function watchPostExpansion() {
    // Create MutationObserver to watch for expanded posts
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.classList && mutation.target.classList.contains('post-content')) {
                if (mutation.target.classList.contains('expanded')) {
                    // Post was expanded
                    generateTOCForPost(mutation.target);
                } else {
                    // Post was collapsed
                    document.getElementById('toc-container').style.display = 'none';
                }
            }
        });
    });
    
    // Start observing all post-content elements
    document.querySelectorAll('.post-content').forEach(function(element) {
        observer.observe(element, { attributes: true, attributeFilter: ['class'] });
    });
}

// Initialize TOC when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the home page with expandable posts
    if (document.querySelector('.post-list')) {
        console.log('Home page detected, setting up TOC for expandable posts');
        makeDraggable();
        watchPostExpansion();
        
        // Check if a post is already expanded (from hash)
        const expandedPost = document.querySelector('.post-content.expanded');
        if (expandedPost) {
            generateTOCForPost(expandedPost);
        } else {
            // Hide TOC initially
            const tocContainer = document.getElementById('toc-container');
            if (tocContainer) tocContainer.style.display = 'none';
        }
        
        // Restore collapsed state from localStorage
        const isCollapsed = localStorage.getItem('toc-collapsed') === 'true';
        if (isCollapsed && document.getElementById('toc-container')) {
            toggleTOC();
        }
        
        // Add scroll listener with throttling
        let scrollTimer;
        window.addEventListener('scroll', function() {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(trackScroll, 50);
        });
    } else if (document.querySelector('.post-content')) {
        // Traditional single post page
        generateTOC();
        makeDraggable();
        
        const isCollapsed = localStorage.getItem('toc-collapsed') === 'true';
        if (isCollapsed) {
            toggleTOC();
        }
        
        let scrollTimer;
        window.addEventListener('scroll', function() {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(trackScroll, 50);
        });
        
        trackScroll();
    }
});
</script>