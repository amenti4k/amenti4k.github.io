<!-- Floating Table of Contents (rebuilt) -->
<nav id="toc-container" class="toc-container" aria-label="On this page">
  <div class="toc-header">On this page</div>
  <div id="toc-nav" class="toc-nav" role="navigation" aria-label="Table of contents"></div>
  <button id="toc-minimize" class="toc-minimize" aria-label="Minimize TOC" title="Minimize">â€“</button>
  <button id="toc-maximize" class="toc-maximize" aria-label="Expand TOC" title="Expand">+</button>
</nav>

<style>
.toc-container {
  position: fixed;
  right: 30px;
  top: 100px;
  bottom: 50px;
  width: 240px;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 100;
  font-family: 'Inconsolata', monospace;
  font-size: 12px;
  line-height: 1.45;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  border-left: 1px solid var(--border, rgba(255,255,255,0.08));
  padding-left: 10px;
}

.toc-container.visible { opacity: 1; pointer-events: auto; }
.toc-container.minimized { opacity: 0.2; }
.toc-container.minimized:hover { opacity: 1; }

.toc-header {
  color: var(--secondary-text-color, #9b9b9b);
  font-weight: 700;
  margin-bottom: 6px;
}

.toc-nav ul { list-style: none; margin: 0; padding: 0; }
.toc-nav li { margin: 0; padding: 2px 0; }
.toc-nav a {
  color: var(--secondary-text-color, #9b9b9b);
  text-decoration: none;
  display: block;
  border-left: 2px solid transparent;
  padding-left: 6px;
  transition: color 0.15s ease, border-color 0.15s ease;
}
.toc-nav a:hover { color: var(--text-color, #e1e1e1); }
.toc-nav a.active { color: var(--text-color, #e1e1e1); border-left-color: var(--text-color, #e1e1e1); }

/* Nested indentation */
.toc-nav ul ul a { padding-left: 16px; font-size: 11px; }
.toc-nav ul ul ul a { padding-left: 28px; font-size: 10px; opacity: 0.9; }

/* Controls */
.toc-minimize, .toc-maximize {
  position: absolute;
  right: 8px;
  background: none;
  border: 1px solid var(--border, rgba(255,255,255,0.15));
  border-radius: 12px;
  width: 24px; height: 24px;
  color: var(--secondary-text-color);
  cursor: pointer;
}
.toc-minimize { top: 8px; }
.toc-maximize { top: 8px; display: none; }
.toc-container.minimized .toc-minimize { display: none; }
.toc-container.minimized .toc-maximize { display: inline-block; }

/* Hide on smaller screens */
@media (max-width: 1200px) { .toc-container { display: none; } }

/* Scrollbar */
.toc-container::-webkit-scrollbar { width: 3px; }
.toc-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
.toc-container::-webkit-scrollbar-thumb { background: var(--secondary-text-color, #9b9b9b); border-radius: 3px; }
.toc-container:hover::-webkit-scrollbar-thumb { background: var(--text-color, #e1e1e1); }
</style>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    // Only render TOC on post pages (single article view)
    const isPostPage = !!document.querySelector('article.post .post-content, article .post-content, .post .post-content');
    if (!isPostPage) return;

    const articleContent = document.querySelector('article .post-content, .post .post-content, .post-content');
    const tocContainer = document.getElementById('toc-container');
    const tocNav = document.getElementById('toc-nav');
    if (!articleContent || !tocContainer || !tocNav) return;

    // Collect headings (ignore H1)
    let headings = Array.from(articleContent.querySelectorAll('h2, h3, h4'));
    if (!headings.length) { tocContainer.classList.remove('visible'); return; }

    // Slugify with Unicode support and unique suffixes
    const slugCounts = new Map();
    function slugify(text) {
      const base = (text || '')
        .trim()
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s-]/gu, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
      const count = (slugCounts.get(base) || 0) + 1;
      slugCounts.set(base, count);
      return count > 1 ? `${base}-${count}` : base;
    }

    // Ensure IDs
    headings.forEach(h => { if (!h.id) h.id = slugify(h.textContent || h.innerText || 'section'); });

    // Build nested structure H2 > H3 > H4
    const rootUl = document.createElement('ul');
    const stack = [{ level: 2, ul: rootUl }];
    function cur() { return stack[stack.length - 1]; }

    headings.forEach(h => {
      const level = parseInt(h.tagName.substring(1), 10);
      // Descend or ascend in the stack to match heading level
      while (cur().level < level) {
        const newUl = document.createElement('ul');
        // Ensure there is at least one li to attach the new ul
        const parentLi = cur().ul.lastElementChild || cur().ul.appendChild(document.createElement('li'));
        parentLi.appendChild(newUl);
        stack.push({ level: cur().level + 1, ul: newUl });
      }
      while (cur().level > level && stack.length > 1) {
        stack.pop();
      }
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${h.id}`;
      a.textContent = (h.textContent || '').trim();
      a.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById(h.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setActive(h.id);
      });
      li.appendChild(a);
      cur().ul.appendChild(li);
    });

    tocNav.innerHTML = '';
    tocNav.appendChild(rootUl);
    tocContainer.classList.add('visible');

    // Active section highlighting
    let allowAutoScroll = false;
    function setActive(id, shouldAutoScroll = allowAutoScroll) {
      const links = tocNav.querySelectorAll('a');
      let activeLink = null;
      links.forEach(link => {
        if (link.getAttribute('href') === `#${id}`) {
          link.classList.add('active');
          activeLink = link;
        } else {
          link.classList.remove('active');
        }
      });
      if (shouldAutoScroll && activeLink) {
        const linkRect = activeLink.getBoundingClientRect();
        const containerRect = tocContainer.getBoundingClientRect();
        if (linkRect.bottom < containerRect.top || linkRect.top > containerRect.bottom) {
          const ideal = activeLink.offsetTop - (tocContainer.clientHeight / 3);
          tocContainer.scrollTo({ top: Math.max(0, ideal), behavior: 'smooth' });
        }
      }
    }

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries) => {
        let topMost = null;
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          if (!topMost || entry.boundingClientRect.top < topMost.boundingClientRect.top) {
            topMost = entry;
          }
        });
        if (topMost?.target?.id) setActive(topMost.target.id);
      }, { root: null, rootMargin: '-20% 0px -75% 0px', threshold: [0] });
      headings.forEach(h => observer.observe(h));
    }

    // Initial state + UX niceties
    tocContainer.scrollTop = 0;
    setActive(headings[0].id, false);
    setTimeout(() => tocContainer.classList.add('minimized'), 2500);

    // Only enable TOC auto-scroll after explicit user interaction (not passive layout scrolls)
    const enableAuto = () => { allowAutoScroll = true; cleanupAuto(); };
    const cleanupAuto = () => {
      window.removeEventListener('wheel', enableAuto, { passive: true });
      window.removeEventListener('touchstart', enableAuto, { passive: true });
      window.removeEventListener('pointerdown', enableAuto, { passive: true });
      window.removeEventListener('keydown', onKeyAuto, true);
    };
    const onKeyAuto = (e) => {
      const keys = ['ArrowDown','ArrowUp','PageDown','PageUp','Home','End','Space'];
      if (keys.includes(e.code) || keys.includes(e.key)) enableAuto();
    };
    window.addEventListener('wheel', enableAuto, { passive: true, once: true });
    window.addEventListener('touchstart', enableAuto, { passive: true, once: true });
    window.addEventListener('pointerdown', enableAuto, { passive: true, once: true });
    window.addEventListener('keydown', onKeyAuto, true);

    // Minimize/expand controls
    const btnMin = document.getElementById('toc-minimize');
    const btnMax = document.getElementById('toc-maximize');
    btnMin?.addEventListener('click', () => tocContainer.classList.add('minimized'));
    btnMax?.addEventListener('click', () => tocContainer.classList.remove('minimized'));
  });
})();
</script>
