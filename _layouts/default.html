<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} Â· {% endif %}{{ site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="site-container">
        <header class="site-header">
            <div class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></div>
            <nav class="site-nav" aria-label="Primary navigation">
                <a href="{{ '/about' | relative_url }}">about</a>
                <a href="{{ '/research' | relative_url }}">research</a>
                <a href="{{ '/vibes' | relative_url }}">vibes</a>
            </nav>
        </header>

        <main role="main">
            {{ content }}
        </main>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <script>
        function convertMermaidCodeBlocks() {
            document.querySelectorAll('code.language-mermaid').forEach(function(block) {
                var parent = block.parentElement;
                var container = parent && parent.tagName === 'PRE' ? parent : block;
                var wrapper = document.createElement('div');
                wrapper.className = 'mermaid';
                wrapper.textContent = block.textContent;
                container.parentNode.replaceChild(wrapper, container);
            });
        }

        function dedupePostTitle() {
            var post = document.querySelector('.post');
            if (!post) return;
            var layoutHeading = post.querySelector('h1');
            var content = post.querySelector('.post-content');
            if (!layoutHeading || !content) return;
            var firstElement = content.firstElementChild;
            if (!firstElement || !firstElement.tagName || firstElement.tagName.toLowerCase() !== 'h1') return;
            if (layoutHeading.textContent.trim() === firstElement.textContent.trim()) {
                firstElement.remove();
            }
        }

        // External link indicator
        function markExternalLinks() {
            const links = document.querySelectorAll('a[href^="http"]');
            const currentHost = window.location.hostname;
            
            links.forEach(function(link) {
                try {
                    const url = new URL(link.href);
                    if (url.hostname !== currentHost && !link.classList.contains('no-external-icon')) {
                        link.classList.add('external-link');
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                } catch (e) {}
            });
        }

        // Back to top button
        function initBackToTop() {
            const btn = document.getElementById('backToTop');
            if (!btn) return;

            window.addEventListener('scroll', function() {
                if (window.scrollY > 400) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            });

            btn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            convertMermaidCodeBlocks();
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false,
                    securityLevel: 'loose',
                    theme: 'neutral'
                });
                mermaid.run({ querySelector: '.mermaid' });
            }
            dedupePostTitle();
            markExternalLinks();
            initBackToTop();
        });
    </script>
</body>
</html>
