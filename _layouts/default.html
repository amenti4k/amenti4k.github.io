<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}" data-theme="{{ site.style | default: 'auto' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} Â· {% endif %}{{ site.title }}</title>

    <script>
        (function() {
            var storageKey = 'theme-preference';
            try {
                var saved = localStorage.getItem(storageKey);
                var fallback = '{{ site.style | default: "auto" }}';
                var theme = saved || fallback;
                document.documentElement.setAttribute('data-theme', theme);
            } catch (err) {
                document.documentElement.setAttribute('data-theme', '{{ site.style | default: "auto" }}');
            }
        })();
    </script>

    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body class="layout-{{ page.layout | default: 'page' }}">
    <div class="site-shell{% if page.layout == 'post' %} site-shell--wide{% endif %}">
        <header class="site-header">
            <span class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></span>
            <nav class="site-nav" aria-label="Primary navigation">
                <a href="{{ '/about' | relative_url }}">about</a>
                <a href="{{ '/research' | relative_url }}">research</a>
                <a href="{{ '/vibes' | relative_url }}">vibes</a>
                <button type="button" id="theme-toggle" class="theme-toggle" aria-live="polite" aria-label="Cycle colour theme"></button>
            </nav>
        </header>
        <main role="main">
            {{ content }}
        </main>
    </div>

    <script>
        const THEME_STORAGE_KEY = 'theme-preference';
        const THEME_SEQUENCE = ['auto', 'dark', 'light', 'dawn', 'neon'];
        const THEME_LABELS = {
            auto: 'system',
            dark: 'midnight',
            light: 'daylight',
            dawn: 'dawn',
            neon: 'neon'
        };

        function resolveStoredTheme() {
            try {
                return localStorage.getItem(THEME_STORAGE_KEY);
            } catch (err) {
                return null;
            }
        }

        function setStoredTheme(theme) {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            } catch (err) {
                /* ignore */
            }
        }

        function currentTheme() {
            return document.documentElement.getAttribute('data-theme') || 'auto';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
        }

        function formatTheme(theme) {
            return (THEME_LABELS[theme] || theme).replace(/^(.)/, function(_, ch) { return ch.toUpperCase(); });
        }

        function updateToggleLabel(themeToggle, theme) {
            var label = formatTheme(theme);
            themeToggle.dataset.themeName = theme;
            themeToggle.setAttribute('aria-label', 'Theme: ' + label + '. Activate to switch.');
            themeToggle.setAttribute('title', 'Theme: ' + label + ' (click to change)');
        }

        function preferredThemeForAuto() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }

        function buildMermaidConfig(theme) {
            if (typeof window.getComputedStyle !== 'function') {
                return { startOnLoad: false, theme: 'dark' };
            }
            var computed = getComputedStyle(document.documentElement);
            var accent = computed.getPropertyValue('--link-color').trim() || '#82aaff';
            var accentHover = computed.getPropertyValue('--link-hover-color').trim() || accent;
            var text = computed.getPropertyValue('--text-color').trim() || '#f5f7ff';
            var border = computed.getPropertyValue('--border-color').trim() || 'rgba(110,128,201,0.35)';
            var surface = computed.getPropertyValue('--surface-color').trim() || computed.getPropertyValue('--background-color').trim() || '#070910';
            var surfaceElevated = computed.getPropertyValue('--surface-elevated-color').trim() || surface;
            var resolved = theme === 'auto' ? preferredThemeForAuto() : theme;
            var mermaidTheme = (resolved === 'light' || resolved === 'dawn') ? 'neutral' : 'dark';

            return {
                startOnLoad: false,
                securityLevel: 'loose',
                theme: mermaidTheme,
                themeVariables: {
                    primaryColor: accent,
                    primaryTextColor: text,
                    primaryBorderColor: accent,
                    lineColor: border,
                    secondaryColor: accentHover,
                    tertiaryColor: border,
                    background: surfaceElevated || surface,
                    mainBkg: surfaceElevated || surface,
                    secondBkg: surface,
                    tertiaryBkg: surface,
                    fontFamily: 'JetBrains Mono, monospace'
                }
            };
        }

        function convertMermaidCodeBlocks() {
            document.querySelectorAll('code.language-mermaid').forEach(function(block) {
                var parent = block.parentElement;
                var container = parent && parent.tagName === 'PRE' ? parent : block;
                var wrapper = document.createElement('div');
                wrapper.className = 'mermaid';
                wrapper.textContent = block.textContent;
                container.parentNode.replaceChild(wrapper, container);
            });
        }

        function refreshMermaid(theme) {
            if (typeof mermaid === 'undefined') {
                return;
            }
            var config = buildMermaidConfig(theme);
            mermaid.initialize(config);
            requestAnimationFrame(function() {
                mermaid.run({ querySelector: '.mermaid' });
            });
        }

        function dedupePostTitle() {
            var post = document.querySelector('.post');
            if (!post) {
                return;
            }
            var layoutHeading = post.querySelector('h1');
            var content = post.querySelector('.post-content');
            if (!layoutHeading || !content) {
                return;
            }
            var firstElement = content.firstElementChild;
            if (!firstElement || !firstElement.tagName || firstElement.tagName.toLowerCase() !== 'h1') {
                return;
            }
            var layoutText = layoutHeading.textContent.trim();
            var contentText = firstElement.textContent.trim();
            if (layoutText === contentText) {
                firstElement.remove();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var themeToggle = document.getElementById('theme-toggle');
            convertMermaidCodeBlocks();

            var stored = resolveStoredTheme();
            var initial = stored || '{{ site.style | default: "auto" }}';
            setTheme(initial);
            if (themeToggle) {
                themeToggle.textContent = '';
                updateToggleLabel(themeToggle, initial);
                themeToggle.addEventListener('click', function() {
                    var current = currentTheme();
                    var index = THEME_SEQUENCE.indexOf(current);
                    var next = THEME_SEQUENCE[(index + 1 + THEME_SEQUENCE.length) % THEME_SEQUENCE.length];
                    setTheme(next);
                    updateToggleLabel(themeToggle, next);
                    setStoredTheme(next);
                    refreshMermaid(next);
                });
            }
            refreshMermaid(initial);
            dedupePostTitle();

            if (window.matchMedia) {
                var media = window.matchMedia('(prefers-color-scheme: dark)');
                var mediaListener = function() {
                    if (currentTheme() === 'auto') {
                        refreshMermaid('auto');
                    }
                };
                if (typeof media.addEventListener === 'function') {
                    media.addEventListener('change', mediaListener);
                } else if (typeof media.addListener === 'function') {
                    media.addListener(mediaListener);
                }
            }
        });
    </script>
</body>
</html>
