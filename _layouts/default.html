<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% seo %}

    <!-- JSON-LD Structured Data for Person Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Amenti Kenea",
      "url": "{{ site.url }}",
      "email": "{{ site.email }}",
      "jobTitle": "Founding Engineer",
      "worksFor": {
        "@type": "Organization",
        "name": "Didero AI"
      },
      "alumniOf": [
        {
          "@type": "Organization",
          "name": "Minerva University"
        },
        {
          "@type": "Organization",
          "name": "Meta"
        }
      ],
      "sameAs": [
        "https://twitter.com/amenti4k",
        "https://www.linkedin.com/in/amenti-kenea/",
        "https://github.com/amenti4k"
      ],
      "description": "Founding Engineer at Didero AI building autonomous AI systems. Previously Data Scientist at Meta. Minerva University alumnus.",
      "knowsAbout": ["Artificial Intelligence", "Machine Learning", "Distributed Systems", "Data Science", "Autonomous Agents"]
    }
    </script>

    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="site-container">
        <header class="site-header">
            <div class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></div>
            <nav class="site-nav" aria-label="Primary navigation">
                <a href="{{ '/about' | relative_url }}">about</a>
                <a href="{{ '/research' | relative_url }}">research</a>
                <a href="{{ '/vibes' | relative_url }}">vibes</a>
            </nav>
        </header>

        <main role="main">
            {{ content }}
        </main>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <!-- Keyboard Shortcuts Help -->
    <div class="kbd-help" id="kbdHelp" aria-hidden="true">
        <div class="kbd-help-content">
            <div class="kbd-help-header">
                <span class="kbd-help-title">Keyboard Shortcuts</span>
                <button class="kbd-help-close" aria-label="Close">&times;</button>
            </div>
            <div class="kbd-help-body">
                <div class="kbd-section">
                    <div class="kbd-section-title">Navigation</div>
                    <div class="kbd-row"><kbd>g</kbd> <kbd>h</kbd> <span>Go home</span></div>
                    <div class="kbd-row"><kbd>g</kbd> <kbd>a</kbd> <span>Go to about</span></div>
                    <div class="kbd-row"><kbd>g</kbd> <kbd>r</kbd> <span>Go to research</span></div>
                    <div class="kbd-row"><kbd>g</kbd> <kbd>v</kbd> <span>Go to vibes</span></div>
                </div>
                <div class="kbd-section">
                    <div class="kbd-section-title">Post List</div>
                    <div class="kbd-row"><kbd>j</kbd> <span>Next post</span></div>
                    <div class="kbd-row"><kbd>k</kbd> <span>Previous post</span></div>
                    <div class="kbd-row"><kbd>o</kbd> / <kbd>Enter</kbd> <span>Open post</span></div>
                </div>
                <div class="kbd-section">
                    <div class="kbd-section-title">General</div>
                    <div class="kbd-row"><kbd>?</kbd> <span>Show this help</span></div>
                    <div class="kbd-row"><kbd>Esc</kbd> <span>Close dialogs</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function convertMermaidCodeBlocks() {
            document.querySelectorAll('code.language-mermaid').forEach(function(block) {
                var parent = block.parentElement;
                var container = parent && parent.tagName === 'PRE' ? parent : block;
                var wrapper = document.createElement('div');
                wrapper.className = 'mermaid';
                wrapper.textContent = block.textContent;
                container.parentNode.replaceChild(wrapper, container);
            });
        }

        function dedupePostTitle() {
            var post = document.querySelector('.post');
            if (!post) return;
            var layoutHeading = post.querySelector('h1');
            var content = post.querySelector('.post-content');
            if (!layoutHeading || !content) return;
            var firstElement = content.firstElementChild;
            if (!firstElement || !firstElement.tagName || firstElement.tagName.toLowerCase() !== 'h1') return;
            firstElement.remove();
        }

        // External link indicator
        function markExternalLinks() {
            const links = document.querySelectorAll('a[href^="http"]');
            const currentHost = window.location.hostname;
            
            links.forEach(function(link) {
                try {
                    const url = new URL(link.href);
                    if (url.hostname !== currentHost && !link.classList.contains('no-external-icon')) {
                        link.classList.add('external-link');
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                } catch (e) {}
            });
        }

        // Back to top button
        function initBackToTop() {
            const btn = document.getElementById('backToTop');
            if (!btn) return;

            window.addEventListener('scroll', function() {
                if (window.scrollY > 400) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            });

            btn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // Keyboard navigation
        function initKeyboardNav() {
            let gPressed = false;
            let gTimeout = null;
            let currentPostIndex = -1;
            
            const helpModal = document.getElementById('kbdHelp');
            const closeBtn = helpModal?.querySelector('.kbd-help-close');
            
            function getVisiblePosts() {
                return Array.from(document.querySelectorAll('.post-item')).filter(
                    p => p.style.display !== 'none'
                );
            }
            
            function focusPost(index) {
                const posts = getVisiblePosts();
                if (posts.length === 0) return;
                
                // Remove previous focus
                posts.forEach(p => p.classList.remove('kbd-focused'));
                
                // Clamp index
                currentPostIndex = Math.max(0, Math.min(index, posts.length - 1));
                
                // Add focus
                const post = posts[currentPostIndex];
                post.classList.add('kbd-focused');
                post.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            function openFocusedPost() {
                const focused = document.querySelector('.post-item.kbd-focused .post-link');
                if (focused) window.location.href = focused.href;
            }
            
            function showHelp() {
                if (helpModal) {
                    helpModal.classList.add('visible');
                    helpModal.setAttribute('aria-hidden', 'false');
                }
            }
            
            function hideHelp() {
                if (helpModal) {
                    helpModal.classList.remove('visible');
                    helpModal.setAttribute('aria-hidden', 'true');
                }
            }
            
            closeBtn?.addEventListener('click', hideHelp);
            helpModal?.addEventListener('click', function(e) {
                if (e.target === helpModal) hideHelp();
            });
            
            document.addEventListener('keydown', function(e) {
                // Ignore if typing in input/textarea
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
                if (e.target.isContentEditable) return;
                
                const key = e.key.toLowerCase();
                
                // Handle 'g' prefix for navigation
                if (gPressed) {
                    clearTimeout(gTimeout);
                    gPressed = false;
                    
                    switch(key) {
                        case 'h': window.location.href = '/'; break;
                        case 'a': window.location.href = '/about'; break;
                        case 'r': window.location.href = '/research'; break;
                        case 'v': window.location.href = '/vibes'; break;
                    }
                    return;
                }
                
                // Single key shortcuts
                switch(key) {
                    case 'g':
                        gPressed = true;
                        gTimeout = setTimeout(() => { gPressed = false; }, 500);
                        break;
                        
                    case 'j':
                        e.preventDefault();
                        focusPost(currentPostIndex + 1);
                        break;
                        
                    case 'k':
                        e.preventDefault();
                        focusPost(currentPostIndex - 1);
                        break;
                        
                    case 'o':
                    case 'enter':
                        if (document.querySelector('.post-item.kbd-focused')) {
                            e.preventDefault();
                            openFocusedPost();
                        }
                        break;
                        
                    case '?':
                        e.preventDefault();
                        showHelp();
                        break;
                        
                    case 'escape':
                        hideHelp();
                        // Remove post focus
                        document.querySelectorAll('.post-item.kbd-focused').forEach(
                            p => p.classList.remove('kbd-focused')
                        );
                        currentPostIndex = -1;
                        break;
                }
            });
        }

        // Gwern-style link hover previews
        function initLinkPreviews() {
            const cache = {};
            let previewEl = null;
            let hoverTimeout = null;
            let currentLink = null;

            function createPreviewEl() {
                const el = document.createElement('div');
                el.className = 'link-preview';
                el.innerHTML = '<div class="link-preview-title"></div><div class="link-preview-meta"></div><div class="link-preview-excerpt"></div><div class="link-preview-fade"></div>';
                document.body.appendChild(el);
                return el;
            }

            function positionPreview(link) {
                if (!previewEl) return;
                const rect = link.getBoundingClientRect();
                const scrollY = window.scrollY;
                const scrollX = window.scrollX;
                let top = rect.bottom + scrollY + 8;
                let left = rect.left + scrollX;

                // Keep within viewport horizontally
                if (left + 340 > window.innerWidth + scrollX) {
                    left = window.innerWidth + scrollX - 350;
                }
                if (left < scrollX + 10) left = scrollX + 10;

                // Flip above if too close to bottom
                if (rect.bottom + 270 > window.innerHeight) {
                    top = rect.top + scrollY - 268;
                }

                previewEl.style.top = top + 'px';
                previewEl.style.left = left + 'px';
            }

            function showPreview(link, data) {
                if (!previewEl) previewEl = createPreviewEl();
                previewEl.querySelector('.link-preview-title').textContent = data.title;
                previewEl.querySelector('.link-preview-meta').textContent = data.date;
                previewEl.querySelector('.link-preview-excerpt').textContent = data.excerpt;
                positionPreview(link);
                requestAnimationFrame(function() {
                    previewEl.classList.add('visible');
                });
            }

            function hidePreview() {
                if (previewEl) previewEl.classList.remove('visible');
                currentLink = null;
            }

            function fetchPreview(url) {
                if (cache[url]) return Promise.resolve(cache[url]);
                return fetch(url)
                    .then(function(r) { return r.text(); })
                    .then(function(html) {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var title = '';
                        var titleEl = doc.querySelector('.post-title-main') || doc.querySelector('h1');
                        if (titleEl) title = titleEl.textContent.trim();
                        var date = '';
                        var dateEl = doc.querySelector('.post-date');
                        if (dateEl) date = dateEl.textContent.trim();
                        var excerpt = '';
                        var contentEl = doc.querySelector('.post-content');
                        if (contentEl) {
                            var paragraphs = contentEl.querySelectorAll('p');
                            for (var i = 0; i < paragraphs.length; i++) {
                                var text = paragraphs[i].textContent.trim();
                                if (text.length > 30) { excerpt = text; break; }
                            }
                        }
                        var data = { title: title, date: date, excerpt: excerpt };
                        cache[url] = data;
                        return data;
                    });
            }

            function isInternalPostLink(link) {
                if (link.hostname !== window.location.hostname) return false;
                var href = link.pathname;
                // Match typical Jekyll post URLs
                if (href.match(/\/\d{4}\/\d{2}\/\d{2}\//)) return true;
                // Match post links from the home page
                if (link.closest('.post-item')) return true;
                return false;
            }

            document.addEventListener('mouseover', function(e) {
                var link = e.target.closest('a');
                if (!link || !isInternalPostLink(link)) return;
                if (link === currentLink) return;
                currentLink = link;
                clearTimeout(hoverTimeout);
                hoverTimeout = setTimeout(function() {
                    fetchPreview(link.href).then(function(data) {
                        if (currentLink === link && data.title) {
                            showPreview(link, data);
                        }
                    });
                }, 200);
            });

            document.addEventListener('mouseout', function(e) {
                var link = e.target.closest('a');
                if (link) {
                    clearTimeout(hoverTimeout);
                    hidePreview();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            convertMermaidCodeBlocks();
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false,
                    securityLevel: 'loose',
                    theme: 'neutral'
                });
                mermaid.run({ querySelector: '.mermaid' });
            }
            dedupePostTitle();
            markExternalLinks();
            initBackToTop();
            initKeyboardNav();
            initLinkPreviews();
        });
    </script>
</body>
</html>
