<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} Â· {% endif %}{{ site.title }}</title>

    <script>
        (function() {
            try {
                var saved = localStorage.getItem('theme');
                document.documentElement.setAttribute('data-theme', saved || 'light');
            } catch (err) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>

    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body class="layout-{{ page.layout | default: 'page' }}">
    <div class="site-shell{% if page.layout == 'post' %} site-shell--wide{% endif %}">
        <header class="site-header">
            <span class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></span>
            <nav class="site-nav" aria-label="Primary navigation">
                <a href="{{ '/about' | relative_url }}">about</a>
                <a href="{{ '/research' | relative_url }}">research</a>
                <a href="{{ '/vibes' | relative_url }}">vibes</a>
                <button type="button" id="theme-toggle" class="theme-toggle" aria-live="polite" aria-label="Cycle colour theme"></button>
            </nav>
        </header>
        <main role="main">
            {{ content }}
        </main>
    </div>

    <script>
        const THEME_STORAGE_KEY = 'theme';

        function getStoredTheme() {
            try {
                return localStorage.getItem(THEME_STORAGE_KEY);
            } catch (err) {
                return null;
            }
        }

        function setStoredTheme(theme) {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            } catch (err) {}
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
        }

        function convertMermaidCodeBlocks() {
            document.querySelectorAll('code.language-mermaid').forEach(function(block) {
                var parent = block.parentElement;
                var container = parent && parent.tagName === 'PRE' ? parent : block;
                var wrapper = document.createElement('div');
                wrapper.className = 'mermaid';
                wrapper.textContent = block.textContent;
                container.parentNode.replaceChild(wrapper, container);
            });
        }

        function refreshMermaid(theme) {
            if (typeof mermaid === 'undefined') return;
            var config = {
                startOnLoad: false,
                securityLevel: 'loose',
                theme: theme === 'dark' ? 'dark' : 'neutral'
            };
            mermaid.initialize(config);
            requestAnimationFrame(function() {
                mermaid.run({ querySelector: '.mermaid' });
            });
        }

        function dedupePostTitle() {
            var post = document.querySelector('.post');
            if (!post) return;
            var layoutHeading = post.querySelector('h1');
            var content = post.querySelector('.post-content');
            if (!layoutHeading || !content) return;
            var firstElement = content.firstElementChild;
            if (!firstElement || !firstElement.tagName || firstElement.tagName.toLowerCase() !== 'h1') return;
            firstElement.remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            var themeToggle = document.getElementById('theme-toggle');
            convertMermaidCodeBlocks();

            var stored = getStoredTheme();
            var initial = stored || 'light';
            setTheme(initial);

            if (themeToggle) {
                themeToggle.setAttribute('aria-label', 'Toggle theme');
                themeToggle.addEventListener('click', function() {
                    var current = document.documentElement.getAttribute('data-theme');
                    var next = current === 'light' ? 'dark' : 'light';
                    setTheme(next);
                    setStoredTheme(next);
                    refreshMermaid(next);
                });
            }

            refreshMermaid(initial);
            dedupePostTitle();
        });
    </script>
</body>
</html>
